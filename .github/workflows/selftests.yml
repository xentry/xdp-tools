name: Selftests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-22.04
    env:
      LLVM_VERSION: 19
      CLANG: clang-19

    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Prepare packages
        run: |
          sudo apt-get update
          sudo apt-get install libpcap-dev libelf-dev gcc-multilib pkg-config bpftool

      - name: Prepare Clang
        run: |
          wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
          echo "deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-$LLVM_VERSION main" | sudo tee -a /etc/apt/sources.list
          sudo apt-get -qq update
          sudo apt-get -qq -y install clang-$LLVM_VERSION lld-$LLVM_VERSION llvm-$LLVM_VERSION

      - name: Configure
        run: ./configure

      - name: Build
        run: make lib xdp-trafficgen

      - name: Run tests
        run: make -C xdp-trafficgen test

